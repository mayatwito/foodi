<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ניהול מסעדות</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS אחיד -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<div class="container">
  <h1 class="page-title">ניהול מסעדות</h1>

  <!-- ===== טופס הוספת מסעדה ===== -->
  <form action="/admin" method="POST" class="form-card">

    <!-- שם מסעדה עם autocomplete -->
    <div class="form-group">
      <label>שם מסעדה:</label>

      <div class="autocomplete-wrapper">
        <input
          type="text"
          name="name"
          class="autocomplete-input"
          placeholder="התחיל להקליד או בחר מהרשימה"
          data-restaurants='[
            {% for r in restaurants %}
              "{{ r.name }}"{% if not loop.last %},{% endif %}
            {% endfor %}
          ]'
          required
        >
        <span class="autocomplete-arrow">▾</span>
        <ul class="autocomplete-list"></ul>
      </div>

      <small class="autocomplete-hint">
        ניתן לבחור מהרשימה או להקליד שם חדש
      </small>
    </div>

    <!-- סוג אוכל -->
    <div class="form-group">
      <label>סוג אוכל:</label>
      <select name="type" required>
        <option value="" disabled selected>— בחרי סוג —</option>
        <option value="איטלקי">איטלקי</option>
        <option value="אסיאתי">אסייתי</option>
        <option value="בשרים">בשרים</option>
        <option value="המבורגר">המבורגר</option>
        <option value="מזרחי">מזרחי</option>
        <option value="חלבי">חלבי</option>
        <option value="בר-מסעדה">בר-מסעדה</option>
      </select>
    </div>

    <!-- מיקום -->
    <div class="form-group">
      <label>מיקום המסעדה (GPS):</label>
      <div class="gps-row">
        <input type="number" step="any" name="lat" id="lat" placeholder="Latitude" required>
        <input type="number" step="any" name="lon" id="lon" placeholder="Longitude" required>
      </div>

      <button type="button" id="locationBtn">
        📍 אתרי אותי
      </button>
    </div>

    <button type="submit">➕ הוסף מסעדה</button>
  </form>

  <!-- ===== טבלת מסעדות ===== -->
  <h2 style="margin-top:40px;">רשימת מסעדות במערכת</h2>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>שם</th>
        <th>סוג</th>
        <th>מצב</th>
        <th>זמן המתנה</th>
        <th>פעולה</th>
      </tr>
    </thead>
    <tbody>
      {% for r in restaurants %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.name }}</td>
        <td>{{ r.type }}</td>
        <td>{{ "פנויה" if r.available else "תפוסה" }}</td>
        <td>{{ r.wait_time }} דקות</td>
        <td>
          <form action="/admin/restaurant/{{ r.id }}/toggle" method="POST">
            <button type="submit">
              {% if r.available %}כבה{% else %}הפעל{% endif %}
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div style="margin-top:30px; text-align:center;">
    <a href="/" class="back-btn">⬅ חזרה לדף הבית</a>
  </div>
</div>

<!-- ===== JS: GPS ===== -->
<script>
  document.getElementById("locationBtn").addEventListener("click", () => {
    if (!navigator.geolocation) {
      alert("הדפדפן לא תומך באיתור מיקום");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      pos => {
        document.getElementById("lat").value = pos.coords.latitude.toFixed(6);
        document.getElementById("lon").value = pos.coords.longitude.toFixed(6);
      },
      () => alert("לא ניתן לאתר מיקום. בדקי הרשאות מיקום.")
    );
  });
</script>

<!-- ===== JS: Autocomplete אחיד ===== -->
<script>
  document.querySelectorAll(".autocomplete-input").forEach(input => {
    const list = input.parentElement.querySelector(".autocomplete-list");
    const items = JSON.parse(input.dataset.restaurants);

    function render(matches) {
      list.innerHTML = "";
      matches.forEach(name => {
        const li = document.createElement("li");
        li.textContent = name;
        li.onclick = () => {
          input.value = name;
          list.style.display = "none";
        };
        list.appendChild(li);
      });
      list.style.display = matches.length ? "block" : "none";
    }

    input.addEventListener("focus", () => render(items));

    input.addEventListener("input", () => {
      const v = input.value.trim();
      render(
        v ? items.filter(x => x.startsWith(v)) : items
      );
    });

    document.addEventListener("click", e => {
      if (!input.contains(e.target) && !list.contains(e.target)) {
        list.style.display = "none";
      }
    });
  });
</script>

</body>
</html>
